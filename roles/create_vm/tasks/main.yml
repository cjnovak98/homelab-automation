---
- name: Check if the MAC address file exists
  stat:
    path: vm_macs.yml
  register: mac_file

- name: Load existing MAC addresses if they exist
  include_vars:
    file: vm_macs.yml
  when: mac_file.stat.exists


- name: Set default VM definitions (with MAC address generation if not set)
  set_fact:
    vms: "{{ vms | map('combine', {'mac_address': item.mac_address if item.mac_address is defined else lookup('community.general.random_mac', '52:54:00') | lower }) | list }}"
  loop: "{{ vms }}"
  loop_control:
    loop_var: item

- name: Save MAC addresses to a file for persistence
  copy:
    content: "{{ vms | to_nice_yaml }}"
    dest: /path/to/mac_addresses.yml




    # - name: Copy VM over
    # command: cp "{{ baseline_image }}" "{{ disk_path }}" ## Don't scream at me, I'm being lazy. It'll get converted into idempotent language.
- name: Create a new VM
  community.libvirt.virt:
    command: define
    xml: "{{ lookup('template', 'vm_xml.j2') }}"
  loop: "{{ vms }}"
  loop_control:
    loop_var: vm
  become: true
