- name: Install all required packages.
  yum:
    name: "@Virtualization,podman,bind-utils,libguestfs-tools,cloud-init,virt-install,lm_sensors, python3-jmespath, cockpit, cockpit-machines,openssh-askpass"
    state: installed
  become: true

- name: Make sure share dir is created
  file:
    path: /mnt/share
    state: directory
  become: true

- name: Generate user and service accounts
  ansible.builtin.user:
    name: "{{ item }}"
  loop: "{{ users + service_accounts }}"
  loop_control:
    label: "{{ item }}"
  become: true

- name: Get all public key files in the directory
  set_fact:
    pub_keys: "{{ lookup('fileglob', 'auth_keys/*.pub') | map('file') | list }}"

- name: Add public keys to authorized_keys
  debug:
    msg: "{{ item }}"
  loop: "{{ pub_keys }}"

#- name: create {{ item }}'s authorized_keys
#  become: true
#  authorized_key:
#    user: "{{ item }}"
#    path: "/home/{{ item }}/.ssh/authorized_keys"
#    key: |
#      {{ lookup('file', 'ansible.ed25519.key.pub') }}
#      {{ lookup('file', 'ansible.rsa.key.pub') }}
#    exclusive: false
#  loop: "{{ lookup(<pull all .pub files in the auth_keys dir) }}"
#  loop_control:
#    label: "{{ item }}"

- name: Allow users and service accounts to sudo nopasswd
  community.general.sudoers:
    name: allow-sudo
    state: present
    user: "{{ item }}"
    commands: ALL
    nopassword: true
  loop: "{{ users + service_accounts }}"
  loop_control:
    label: "{{ item }}"
  become: true

- name: Append libvirt,wheel to users and service accounts
  user:
    name: "{{ item }}"
    groups:
      - wheel
      - libvirt
  loop: "{{ users + service_accounts }}"
  loop_control:
    label: "{{ item }}"
  become: true

- name: Remove service account passwords
  ansible.builtin.user:
    name: "{{ item }}"
    password: "*"
  loop: "{{ service_accounts }}"
  loop_control:
    label: "{{ item }}"
  become: true
